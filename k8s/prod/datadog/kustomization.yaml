apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: datadog

resources:
  - namespace.yaml
  - vault.yaml

helmCharts:
- name: datadog
  releaseName: datadog
  namespace: datadog
  version: 3.110.13
  includeCRDs: true
  repo: https://helm.datadoghq.com
  valuesInline:
    providers:
      talos:
        enabled: true
    datadog:
      confd:
        argocd.yaml: |-
          instances:
            -
              app_controller_endpoint: http://argocd-application-controller-metrics.argocd.svc.cluster.local:8082/metrics
              api_server_endpoint: http://argocd-server-metrics.argocd.svc.cluster.local:8083/metrics
              repo_server_endpoint: http://argocd-repo-server-metrics.argocd.svc.cluster.local:8084/metrics
      apiKeyExistingSecret:  datadog
      logs:
        enabled: true
        containerCollectAll: true
      networkMonitoring:
        enabled: true
      serviceMonitoring:
        enabled: true
      systemProbe:
        mountPackageManagementDirs:
        - name: "public-key-dir"
          hostPath: /etc/pki
          mountPath: /host/etc/pki
      envFrom:
        - secretRef:
            name: datadog
    clusterAgent:
      resources:
        requests:
          cpu: 78m
          memory: 105M
        limits:
          cpu: 78m
          memory: 105M
    agents:
      containers:
        agent:
          resources:
            requests:
              cpu: 1469m
              memory: 381M
            limits:
              cpu: 1469m
              memory: 381M
        traceAgent:
          resources:
            requests:
              cpu: 35m
              memory: 94M
            limits:
              cpu: 35m
              memory: 94M
        processAgent:
          resources:
            requests:
              cpu: 49m
              memory: 110M
            limits:
              cpu: 49m
              memory: 110M
