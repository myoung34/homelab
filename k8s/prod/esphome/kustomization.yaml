apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: esphome

resources:
  - namespace.yaml
  - traefik.yaml
  - vault.yaml
  - configmap.yaml

helmCharts:
- name: esphome
  includeCRDs: true
  namespace: esphome
  releaseName: esphome
  version: 8.4.2
  repo: https://k8s-at-home.com/charts/
  valuesInline:
    hostNetwork: true
    env:
      ESPHOME_DASHBOARD_USE_PING: true
    image:
      tag: '2023.9.0'
    securityContext:
      privileged: true
      capabilities:
        add:
          - NET_ADMIN
          - NET_RAW
          - SYS_ADMIN
    persistence:
      dbus:
        enabled: true
        type: hostPath
        hostPath: /var/run/dbus
        mountPath: /run/dbus
        readOnly: true
      tmp-config:
        type: custom
        enabled: true
        mountPath: /config
        volumeSpec:
          emptyDir: {}
      configmap:
        type: custom
        enabled: true
        volumeSpec:
          configMap:
            name: esphome
      secrets:
        type: custom
        enabled: true
        volumeSpec:
          secret:
            secretName: esphome
    initContainers:
      copy:
        image: alpine:latest
        imagePullPolicy: IfNotPresent
        command: ["/bin/sh", "-c", "apk add -U --no-cache curl; cp /configs/*.yaml /config/; echo $SECRETS_YAML | base64 -d >/config/secrets.yaml; curl -sL https://raw.githubusercontent.com/myoung34/plaato-keg-esphome/main/plaato_keg.yaml -o /config/plaato_keg.yaml"]
        env:
          - name: SECRETS_YAML
            valueFrom:
              secretKeyRef:
                name: esphome
                key: secrets
        volumeMounts:
        - name: tmp-config
          mountPath: /config
        - name: configmap
          mountPath: /configs/
        - name: secrets
          mountPath: /etc/secrets
          readOnly: true
